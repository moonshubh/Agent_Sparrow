name: Release Please

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      notify_tag:
        description: "Send Slack notification for this tag (e.g. v0.2.3). Leave empty to run release-please normally."
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: release-please
  cancel-in-progress: false

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
      html_url: ${{ steps.release.outputs.html_url }}
      pr: ${{ steps.release.outputs.pr }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

      # ---------------------------------------------------------------
      # Checkout is needed for both PR enrichment and release enrichment
      # ---------------------------------------------------------------
      - name: Checkout
        if: ${{ steps.release.outputs.pr || steps.release.outputs.release_created }}
        uses: actions/checkout@v4

      # ---------------------------------------------------------------
      # Enrich the release PR body with CodeRabbit summaries
      # (cosmetic â€” helps reviewers see what's in the release)
      # ---------------------------------------------------------------
      - name: Enrich Release PR
        if: ${{ steps.release.outputs.pr && !steps.release.outputs.release_created }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.release.outputs.pr && fromJSON(steps.release.outputs.pr).number || '' }}
          REPO: ${{ github.repository }}
          MODE: pr
        run: bash .github/scripts/enrich-release-notes.sh

      # ---------------------------------------------------------------
      # On actual release: enrich the GitHub release body, then notify
      # Release-please sets the body from CHANGELOG.md, so we overwrite
      # it with our enriched version before Slack reads it.
      # ---------------------------------------------------------------
      - name: Release Info
        if: ${{ steps.release.outputs.release_created }}
        env:
          TAG_NAME: ${{ steps.release.outputs.tag_name }}
          VERSION: ${{ steps.release.outputs.version }}
          HTML_URL: ${{ steps.release.outputs.html_url }}
        run: |
          echo "## Release Created" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Tag:** ${TAG_NAME}" >> "$GITHUB_STEP_SUMMARY"
          echo "**Version:** ${VERSION}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "View the release at: ${HTML_URL}" >> "$GITHUB_STEP_SUMMARY"

      - name: Enrich GitHub Release
        if: ${{ steps.release.outputs.release_created }}
        id: enrich
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          MODE: release
          TAG_NAME: ${{ steps.release.outputs.tag_name }}
          VERSION: ${{ steps.release.outputs.version }}
        run: bash .github/scripts/enrich-release-notes.sh

  # -----------------------------------------------------------------
  # Slack notification â€” separate job to ensure release enrichment
  # has completed before we read the release body.
  # -----------------------------------------------------------------
  notify-slack:
    needs: release-please
    if: ${{ always() && (needs.release-please.outputs.release_created == 'true' || inputs.notify_tag != '') }}
    runs-on: ubuntu-latest
    steps:
      - name: Resolve tag
        id: resolve
        run: |
          # Manual dispatch overrides release-please output
          if [ -n "${{ inputs.notify_tag }}" ]; then
            TAG="${{ inputs.notify_tag }}"
          else
            TAG="${{ needs.release-please.outputs.tag_name }}"
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=${TAG#v}" >> "$GITHUB_OUTPUT"

      - name: Fetch enriched release body
        id: fetch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_NAME: ${{ steps.resolve.outputs.tag }}
        run: |
          # Small delay to ensure release edit has propagated
          sleep 5

          RELEASE_BODY=$(gh release view "$TAG_NAME" \
            --repo "${{ github.repository }}" \
            --json body -q '.body' 2>/dev/null || echo "")

          if [ -z "$RELEASE_BODY" ]; then
            RELEASE_BODY="Release ${TAG_NAME} published. See GitHub for details."
          fi

          {
            echo "body<<RELEASE_EOF"
            printf '%s\n' "$RELEASE_BODY"
            echo "RELEASE_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Prepare Slack changelog
        id: changelog
        env:
          RELEASE_BODY: ${{ steps.fetch.outputs.body }}
        run: |
          # Convert GitHub markdown to Slack mrkdwn:
          #   [text](url) â†’ <url|text>
          #   **bold**    â†’ *bold*
          #   ### Header  â†’ *Header*
          SLACK_BODY=$(printf '%s' "$RELEASE_BODY" | \
            sed -E 's/\[([^]]+)\]\(([^)]+)\)/<\2|\1>/g' | \
            sed -E 's/\*\*([^*]+)\*\*/*\1*/g' | \
            sed -E 's/^### (.+)/*\1*/g' | \
            sed -E 's/^## .+//g')

          # Strip boilerplate
          SLACK_BODY=$(printf '%s' "$SLACK_BODY" | \
            sed '/^:robot:/d' | \
            sed '/^---$/d' | \
            sed '/^This PR was generated/d' | \
            sed '/Release notes enriched/d' | \
            sed '/^$/{ N; /^\n$/d; }')

          # Trim leading/trailing blank lines
          SLACK_BODY=$(printf '%s' "$SLACK_BODY" | sed '/./,$!d' | sed -e :a -e '/^\n*$/{$d;N;ba' -e '}')

          # Slack section block limit is 3000 chars.
          BODY_LEN=${#SLACK_BODY}

          if [ "$BODY_LEN" -le 2900 ]; then
            {
              echo "part1<<SLACKEOF1"
              printf '%s\n' "$SLACK_BODY"
              echo "SLACKEOF1"
            } >> "$GITHUB_OUTPUT"
            echo "has_overflow=false" >> "$GITHUB_OUTPUT"
          else
            # Split at a line boundary near 2800 chars
            CUTPOINT=$(printf '%s' "$SLACK_BODY" | head -c 2800 | wc -l | tr -d ' ')
            PART1=$(printf '%s' "$SLACK_BODY" | head -n "$CUTPOINT")
            PART2=$(printf '%s' "$SLACK_BODY" | tail -n +"$((CUTPOINT + 1))" | head -c 2800)

            {
              echo "part1<<SLACKEOF1"
              printf '%s\n' "$PART1"
              echo "SLACKEOF1"
            } >> "$GITHUB_OUTPUT"

            {
              echo "part2<<SLACKEOF2"
              printf '%s\n' "$PART2"
              echo "SLACKEOF2"
            } >> "$GITHUB_OUTPUT"

            echo "has_overflow=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Notify Slack (single block)
        if: ${{ steps.changelog.outputs.has_overflow == 'false' }}
        uses: slackapi/slack-github-action@v2.0.0
        continue-on-error: true
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: "C09MV869UPK"
            text: "ðŸš€ Agent Sparrow ${{ steps.resolve.outputs.tag }} Released"
            blocks:
              - type: "header"
                text:
                  type: "plain_text"
                  text: "ðŸš€ New Release: Agent Sparrow ${{ steps.resolve.outputs.tag }}"
                  emoji: true
              - type: "section"
                fields:
                  - type: "mrkdwn"
                    text: "*Version:*\n${{ steps.resolve.outputs.version }}"
                  - type: "mrkdwn"
                    text: "*Tag:*\n${{ steps.resolve.outputs.tag }}"
              - type: "divider"
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: ${{ toJSON(steps.changelog.outputs.part1) }}
              - type: "divider"
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "ðŸ“‹ <https://github.com/${{ github.repository }}/releases/tag/${{ steps.resolve.outputs.tag }}|View Full Release Notes on GitHub>"

      - name: Notify Slack (multi-block)
        if: ${{ steps.changelog.outputs.has_overflow == 'true' }}
        uses: slackapi/slack-github-action@v2.0.0
        continue-on-error: true
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: "C09MV869UPK"
            text: "ðŸš€ Agent Sparrow ${{ steps.resolve.outputs.tag }} Released"
            blocks:
              - type: "header"
                text:
                  type: "plain_text"
                  text: "ðŸš€ New Release: Agent Sparrow ${{ steps.resolve.outputs.tag }}"
                  emoji: true
              - type: "section"
                fields:
                  - type: "mrkdwn"
                    text: "*Version:*\n${{ steps.resolve.outputs.version }}"
                  - type: "mrkdwn"
                    text: "*Tag:*\n${{ steps.resolve.outputs.tag }}"
              - type: "divider"
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: ${{ toJSON(steps.changelog.outputs.part1) }}
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: ${{ toJSON(steps.changelog.outputs.part2) }}
              - type: "divider"
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "ðŸ“‹ <https://github.com/${{ github.repository }}/releases/tag/${{ steps.resolve.outputs.tag }}|View Full Release Notes on GitHub>"
